<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>Open Images Search</title>
  <link rel="stylesheet" type="text/css" href="semantic/dist/semantic.min.css">
  <script src="https://code.jquery.com/jquery-3.1.1.min.js"
    integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
  <script src="semantic/dist/semantic.min.js"></script>
  <script>
    const query = new URLSearchParams(window.location.search).get('q')
    if (query == "") {
      location.href = "index.html"
    }
  </script>
</head>

<body>
  <!-- navigation bar -->
  <div class="ui fixed menu">
    <div class="ui container">
      <h3 class="item header"><a class="violet" href="index.html">Open Images Search</a></h3>
      <div class="left menu" style="width: 500px;">
        <div class="item" style="width: 100%;">
          <div class="ui search" style="width: 100%;">
            <form class="ui fluid icon input" action="result.html">
              <input id="input" name="q" class="prompt" type="text" placeholder="What kind of images are you looking for?">
              <i class="search link icon" onclick="$('form').submit()"></i>
            </form>
            <div class="results"></div>
          </div>
        </div>
      </div>
      <div class="right menu">
        <a class="item">About</a>
        <a class="item">Fork on Github</a>
      </div>
    </div>
  </div>
  <!-- results -->
  <div class="ui container" style="margin-top: 80px;">
    <div hidden>
      <div id="card-template" class="ui card">
        <div class="image">
          <img class="thumbnail">
        </div>
      </div>
    </div>
    <div class="ui four stackable cards" id="image-list">
    </div>
  </div>
  <!-- dialog -->
  <div class="ui card modal" style="width:auto; height:auto;">
    <!-- <i class="close icon"></i> -->
    <a id="original-landing" href="https://owldb.net/artist/ikuta-lilas/" class="image">
      <img id="original-image" style="width:400px;height:400px;" src="https://owldb.net/wp-content/uploads/2020/06/Ikura.jpg">
      <div id="image-loader" class="ui loader"></div>
    </a>
    <div class="content">
      <span class="right floated">
        <!-- <i class="heart outline like icon"></i> -->
        <a id="dialog-license" href="https://creativecommons.org/licenses/by/2.0/">
          License
        </a>
      </span>
      <a id="dialog-title" href="https://owldb.net/artist/ikuta-lilas/" class="header">Ikuta Rira!</a>
      <div class="meta">
        <a id="dialog-author-link" href="https://www.youtube.com/channel/UCztEY6czNyJKjRWMwuur9bg">
          <span id="dialog-author" class="author">YOASOBI</span>
        </a>
      </div>
    </div>
  </div>
</body>
<style>
  .thumbnail {
    object-fit: cover;
    max-height: calc(min(250px, 20vw));
    min-height: calc(min(250px, 20vw));
  }
</style>
<script>
  function getLicenseName(url)
  {
    if (url == "https://creativecommons.org/licenses/by/2.0/") return 'CC-BY 2.0';
    return "License";
  }
  // $('.ui.modal').modal({duration:300}).modal('show')
  document.getElementById('input').value = query
  let template = document.getElementById("card-template")
  let list = document.getElementById("image-list")
  // get search results
  let xhr = new XMLHttpRequest
  xhr.open("GET", "http://166.111.69.22:3000/query?q=" + encodeURIComponent(query))
  xhr.onload = () => {
    if (xhr.status == 200) {
      let urllist = JSON.parse(xhr.responseText).urllist
      for (const url of urllist) {
        new Promise((resolve, reject) => {
          let xhr = new XMLHttpRequest();
          xhr.open('GET', url.Thumbnail300KURL, true);
          xhr.responseType = 'blob';
          xhr.onload = function (e) {
            if (this.status !== 200 || this.response.size < 10 * 1024) reject()
            else {
              console.log(this.response.size)
              resolve(this.response)
            }
          };
          xhr.send();
        }).then((blob) => {
          let o = template.cloneNode(true)
          const urlCreator = window.URL || window.webkitURL;
          const imageURL = urlCreator.createObjectURL(blob);
          o.children[0].children[0].src = imageURL;
          o.onclick = function () {
            // display large image
            document.getElementById('original-landing').href = url.OriginalLandingURL
            let img = document.getElementById('original-image')
            img.src = imageURL;
            img.onload = function(){
              let aspect = img.naturalWidth / img.naturalHeight
              console.log("aspect", aspect)
              img.style.width = `calc(min(80vw, 75vh*${aspect}))`
              img.style.height = `calc(min(75vh, 80vw/${aspect}))`
              img.src = url.OriginalURL;
              img.onload = function(){
                document.getElementById("image-loader").classList.add("disabled")
              }
            }
            // display metadata
            document.getElementById("image-loader").classList.remove("disabled")
            document.getElementById("dialog-author").innerText = url.Author
            document.getElementById("dialog-author-link").href = url.AuthorProfileURL
            document.getElementById("dialog-title").innerText = url.Title
            document.getElementById("dialog-title").href = url.OriginalLandingURL
            document.getElementById("dialog-license").innerText = getLicenseName(url.License)
            document.getElementById("dialog-license").href = url.License
            // show
            $('.ui.modal').modal({duration:300}).modal('show')
          }
          list.appendChild(o)
        }, () => { })
      }
    }
  }
  xhr.send()
  // input prompt
  $('.ui.search')
    .search({
      apiSettings: {
        url: 'http://166.111.69.22:3000/prompt?q={query}'
      }
    })
</script>

</html>