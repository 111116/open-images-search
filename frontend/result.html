<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>Open Images Search</title>
  <link rel="stylesheet" type="text/css" href="semantic/dist/semantic.min.css">
  <script src="https://code.jquery.com/jquery-3.1.1.min.js"
    integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
  <script src="semantic/dist/semantic.min.js"></script>
  <script>
    const query = new URLSearchParams(window.location.search).get('q')
    if (query == "") {
      location.href = "index.html"
    }
  </script>
</head>

<body>
  <!-- navigation bar -->
  <div class="ui fixed menu">
    <div class="ui container">
      <h3 class="item header"><a class="violet" href="index.html">Open Images Search</a></h3>
      <div class="left menu" style="width: 500px;">
        <div class="item" style="width: 100%;">
          <div class="ui search" style="width: 100%;">
            <form class="ui fluid icon input" action="result.html">
              <input id="input" name="q" class="prompt" type="text" placeholder="What kind of images are you looking for?">
              <i class="search link icon" onclick="$('form').submit()"></i>
            </form>
            <div class="results"></div>
          </div>
        </div>
      </div>
      <div class="right menu">
        <a class="item">About</a>
        <a class="item">Fork on Github</a>
      </div>
    </div>
  </div>
  <!-- results -->
  <div class="ui container" style="margin-top: 80px;">
    <div hidden>
      <div id="card-template" class="ui card">
        <div class="image">
          <img class="thumbnail">
        </div>
      </div>
    </div>
    <div class="ui four stackable cards" id="image-list">
    </div>
  </div>
  <!-- dialog -->
  <div class="ui card modal" style="width:auto; height:auto;">
    <!-- <i class="close icon"></i> -->
    <a id="original-landing" href="https://www.google.com" class="image">
      <img id="original-image" style="max-height: 80vh;" src="">
    </a>
  </div>
</body>
<style>
  .thumbnail {
    object-fit: cover;
    max-height: 250px;
    min-height: 250px;
  }
</style>
<script>
  document.getElementById('input').value = query
  let template = document.getElementById("card-template")
  let list = document.getElementById("image-list")
  // get search results
  let xhr = new XMLHttpRequest
  xhr.open("GET", "http://166.111.69.22:3000/query?q=" + encodeURIComponent(query))
  xhr.onload = () => {
    if (xhr.status == 200) {
      let urllist = JSON.parse(xhr.responseText).urllist
      for (const url of urllist) {
        new Promise((resolve, reject) => {
          let xhr = new XMLHttpRequest();
          xhr.open('GET', url.Thumbnail300KURL, true);
          xhr.responseType = 'blob';
          xhr.onload = function (e) {
            if (this.status !== 200 || this.response.size < 10 * 1024) reject()
            else {
              console.log(this.response.size)
              resolve(this.response)
            }
          };
          xhr.send();
        }).then((blob) => {
          let o = template.cloneNode(true)
          const urlCreator = window.URL || window.webkitURL;
          const imageURL = urlCreator.createObjectURL(blob);
          o.children[0].children[0].src = imageURL;
          o.onclick = function () {
            document.getElementById('original-landing').href = url.OriginalLandingURL
            document.getElementById('original-image').src = imageURL;
            $('.ui.modal').modal('show')
          }
          list.appendChild(o)
        }, () => { })
      }
    }
  }
  xhr.send()
  // input prompt
  $('.ui.search')
    .search({
      apiSettings: {
        url: 'http://166.111.69.22:3000/prompt?q={query}'
      }
    })
</script>

</html>